---
layout:     post
title: 	    "Log Rotation and Syslog Forwarding"
post_author:	    
post_date:	    Thu, 18 Sep 2014 05:13:19 +0000
post_site:	    xenserver.org 
post_link:	    http://xenserver.org/blog/entry/log-rotation-and-syslog-forwarding.html
---
<html><body><div><div class="blog-text clearfix prel mtm mbm">&#13;
&#13;
			&#13;
			&#13;
			&#13;
			&#13;
			&#13;
			&#13;
			&#13;
			&#13;
			<h2>A Continuation of Root Disk Management</h2>&#13;
<p>First, this article is applicable to <strong>any sized </strong>XenServer deployment and secondly, it is a continuation off of my <a href="http://xenserver.org/component/easyblog/entry/xenserver-root-disk-maintenance.html" target="_blank">previous article</a> regarding XenServer root disk maintenance.  The difference is that - for all XenServer deployments - the topic revolves specifically with that of Syslog: from tuning log rotation, specifying the amount of logs to retain, leveraging compression, and of course... Syslog forwarding.</p>&#13;
<p>All of this is an effort to share tips to new (or seasoned) XenServer Administrators in the options available to ensure necessary Syslog data does not fill a XenServer root disk <strong>while </strong>ensuring - for certain industry specific requirements - that log-specific data is retained without sacrafice.</p>&#13;
<h2>Syslog: A Quick Introduction</h2>&#13;
<p>So, what is this Syslog?  In short it can be compared to the Unix/Linux equivalent of Windows Event Log (along with other logging mechanisms popular to specific applications/Operating Systems). </p>&#13;
<p>The slightly longer explanation is that Syslog is not only a daemon, but also a protocol: established long ago for Unix systems to record system and application to local disk as well as offering the ability to forward the same log information to its peers for redundancy, concentration, and to conserve disk space on highly active systems.  For more detailed information on the finer details of the Syslog protocol and daemon one can review the IETF's specification at <a href="http://tools.ietf.org/html/rfc5424" target="_blank">http://tools.ietf.org/html/rfc5424</a>.</p>&#13;
<p>On a <strong>stand-alone XenServer</strong>, the Syslog daemon is started on boot and its configuration file for handling source, severity, types of logs, and where to store them are defined in /etc/syslog.conf.  It is highly recommended that one <strong>does not </strong>alter this file unless necessary and if one knows what they are doing.  From boot to reboot, information is stored in various files: found under the root disk's /var/log directory.</p>&#13;
<p>Taken from a fresh installation of XenServer, the following shows various log files that store information specific to a purpose.  Note that the items in "brown" are sub-directories:</p>&#13;
<p><img src="http://xenserver.org/blog/entry/log-rotation-and-syslog-forwarding.html" border="0" alt=""/></p>&#13;
<p>For those seasoned in administering XenServer it is visible that from the kernel-level and user-space level there are not many log files.  However, XenServer is verbose about logging for a very simple reason: collection, analysis, and troubleshooting if an issue should arise.</p>&#13;
<p>So for a lone XenServer (by default) logs are essentially received by the Syslog daemon and based on /etc/syslog.conf - as well as the source and type of message - stored on the local root file system as discussed:<br/><img src="http://xenserver.org/blog/entry/log-rotation-and-syslog-forwarding.html" border="0" alt=""/></p>&#13;
<p>Within a pooled XenServer environment things are pretty much the same: for the most part.  As a pool has a master server, log data for the Storage Manager (as a quick example) is trickled up to the master server.  This is to ensure that while each pool member is recording log data specific to itself, the master server has the aggregate log data needed to promote troubleshooting of the entire pool from one point.</p>&#13;
<p><img src="http://xenserver.org/blog/entry/log-rotation-and-syslog-forwarding.html" border="0" alt=""/></p>&#13;
<h2>Log Rotation</h2>&#13;
<p>Log rotation, or "logrotate", is what ensures that Syslog files in /var/log do not grow out of hand.  Much like Syslog, logrotate utilizes a configuration file to dictate how often, at what size, and if compression should be used when archiving a particular Syslog file.  The term "archive" is truly meant for rotating out a current log in place of a fresh, current log to take its place.</p>&#13;
<p>Post XenServer installation and before usage, one can measure the amount of free root disk space by executing the following command:</p>&#13;
<pre>df -h</pre>&#13;
<p>The output will be similar to the following and the line one should be most concerned with is in bold font:</p>&#13;
<pre>Filesystem            Size  Used Avail Use% Mounted on<br/><strong>/dev/sda1             4.0G  1.9G  2.0G  49% /</strong><br/>none                  381M   16K  381M   1% /dev/shm<br/>/opt/xensource/packages/iso/XenCenter.iso<br/>                       52M   52M     0 100% /var/xen/xc-install</pre>&#13;
<p>Once can see by the example that only 49% of the root disk on this XenServer host has been used.  Repeating this process as implementation ramps up, an administrator should be able to measure how best to tune logrotate's configuration file for after install, /etc/logrotate should resemble the following:</p>&#13;
<pre># see "man logrotate" for details<br/># rotate log files weekly<br/>weekly<br/># keep 4 weeks worth of backlogs<br/>rotate 4<br/># create new (empty) log files after rotating old ones<br/>create<br/># uncomment this if you want your log files compressed<br/>#compress<br/># RPM packages drop log rotation information into this directory<br/>include /etc/logrotate.d<br/># no packages own wtmp -- we'll rotate them here<br/>/var/log/wtmp {<br/>    monthly<br/>    minsize 1M<br/>    create 0664 root utmp<br/>    rotate 1<br/>}<br/>/var/log/btmp {<br/>    missingok<br/>    monthly<br/>    minsize 1M<br/>    create 0600 root utmp<br/>    rotate 1<br/>}<br/># system-specific logs may be also be configured here.<br/><br/></pre>&#13;
<p>In previous versions, /etc/logrotate.conf was setup to retain 999 archived/rotated logs, but as of 6.2 the configuration above is standard. </p>&#13;
<p>Before covering the basic premise and purpose of this configuration file, one can see this exact configuration file explained in more detail at <a href="http://www.techrepublic.com/article/manage-linux-log-files-with-logrotate/" target="_blank">http://www.techrepublic.com/article/manage-linux-log-files-with-logrotate/</a></p>&#13;
<p>The options declared in the default configuration are conditions that, when met, rotate logs accordingly:</p>&#13;
<ol><li>The first option specifies <em>when</em> to invoke log rotation.  By default this is set to weekly and may need to be adjusted for "daily".  This will only swap log files out for new ones and will not <strong>delete </strong>log files.</li>&#13;
<li>The second option specifies <em>how long </em>to keep archived/rotate log files on the disk.  The default is to remove archived/rotated log files after a <strong>week</strong>.  This will delete log files that meet this age.</li>&#13;
<li>The third options specifies <em>what </em>to do after rotating a log file out.  The default - <strong>which should not be changed </strong>is to create a new/fresh log after rotating out its older counterpart.</li>&#13;
<li>The fourth option - which is commented out - specifies another <em>what </em>to do, but this time for the archived log files.  It is highly recommended to remove the comment mark so that archived log files are compressed: saving on disk space.</li>&#13;
<li>A fifth option which is not present in the default conf is the "size" option.  This specifies <em>how </em>to handle logs that reach a certain size, such as "size 15M".  This option should be employed: especially if an administrator has SNMP logs that grow exponentially or notices that the particular XenServer's Syslog files are growing faster than logrotate can rotate and dispose of archived files.</li>&#13;
<li>The "include" option specifies a sub-directory wherein unique, logrotate configurations can be specified for individual log files.</li>&#13;
<li>The remaining portion should be left <strong>as is</strong></li>&#13;
</ol><p><strong><br/></strong>In summary for logrotate, one is advised to measure use of the root disk using "df -h" and to tune logrotate.conf as needed to ensure Syslog does not inadvertently consume available disk space.</p>&#13;
<h2>And Now: Syslog Forwarding</h2>&#13;
<p>Again, this is a long standing feature and one I have been looking forward to explaining, highlighting, and providing examples for.  However, I have had a kind of writers block for many reasons: mainly that it ties into Syslog, Logrotate, and XenCenter, but also that there is a tradeoff.</p>&#13;
<p>I mentioned before that Syslog can forward messages to other hosts.  Furthermore, it can forward Syslog messages to other hosts <em>without </em>writing a copy of the log to local disk.  What this means is that a single XenServer or a pool of XenServers can send their log data to a "Syslog Aggregator".</p>&#13;
<p>The trade off is that one cannot generate a server status report via XenCenter, but instead gather the logs from the Syslog aggregate server and manually submit them for review.  That being said, one can <strong>ensure</strong> that low root disk space is not nearly as high of a concern on the "Admin Todo List" and can retain vast amounts of log data for a deployment of any size: based on dictated industry practices or for, sarcastically, nostalgic purposes.</p>&#13;
<p>The principles with Syslog and logrotate.conf will apply to the Syslog Aggregator as what good is a Syslog server if not configured properly as to ensure <strong>it </strong>does not fill itself up?  The requirements to instantiate a Syslog aggregation server, configure the forwarding of Syslog messages, and so forth are quite simple:</p>&#13;
<ol><li>Port 514 must be opened on the network</li>&#13;
<li>The Syslog aggregation server must be reachable - either by being on the same network segment or not - by each XenServer host</li>&#13;
<li>The Syslog aggregation server can be a virtual or physical machine; Windows or Linux-based with either a native Syslog daemon configured to <strong>receive </strong>external host messages or using a Windows-based Syslog solution offering the same "listening" capabilities.</li>&#13;
<li>The Syslog aggregation server <strong>must </strong>have a static IP assigned to it</li>&#13;
<li>The Syslog aggregation server should be monitored and tuned just as if it were Syslog/logrotate on a XenServer</li>&#13;
<li>For support purposes, logs should be easily copied/compressed from the Syslog aggregation server - such as using WinSCP, scp, or other tools to copy log data for support's analysis</li>&#13;
</ol><p>The quickest means to establish a simple virtual or physical Syslog aggregation server - in my opinion - is to reference the following two links.  These describe the installation of a base Debian-based system with specific intent to leverage Rsyslog for the recording of remote Syslog messages sent to it over UDP port 514 from one's XenServers:</p>&#13;
<p><a href="http://www.aboutdebian.com/syslog.htm" target="_blank">http://www.aboutdebian.com/syslog.htm</a></p>&#13;
<p><a href="http://www.howtoforge.com/centralized-rsyslog-server-monitoring" target="_blank">http://www.howtoforge.com/centralized-rsyslog-server-monitoring</a></p>&#13;
<p>Alternatively, the following is an all-in-one guide (using Debian) with Syslog-NG:</p>&#13;
<p><a href="http://www.binbert.com/blog/2010/04/syslog-server-installation-configuration-debian/" target="_blank">http://www.binbert.com/blog/2010/04/syslog-server-installation-configuration-debian/</a></p>&#13;
<p>Once the server is instantiated and ready to record remote Syslog messages, it is time to open XenCenter.  Right click on a pool master or stand-alone XenServer and select "Properties":</p>&#13;
<p><br/><img src="http://xenserver.org/blog/entry/log-rotation-and-syslog-forwarding.html" border="0" alt=""/></p>&#13;
<p>In the window that appear - in the lower left-hand corner - is an option for "Log Destination":</p>&#13;
<p><img src="http://xenserver.org/blog/entry/log-rotation-and-syslog-forwarding.html" border="0" alt=""/></p>&#13;
<p>To the right, one should notice the default option selected is "Local".  From there, select the "Remote" option and enter the IP address (or FQDN) of the remote Syslog aggregate server as follows:</p>&#13;
<p><img src="http://xenserver.org/blog/entry/log-rotation-and-syslog-forwarding.html" border="0" alt=""/></p>&#13;
<p>Finally, select "OK" and the stand-alone XenServer (or pool) will update its Syslog configuration, or more specifically, /var/lib/syslog.conf.  The reason for this is so Elastic Syslog can take over the normal duties of Syslog: forwarding messages to the Syslog aggregator accordingly.</p>&#13;
<p>For example, once configured, the local /var/log/kern.log file will state:</p>&#13;
<pre>Sep 18 03:20:27 bucketbox kernel: Kernel logging (proc) stopped.<br/>Sep 18 03:20:27 bucketbox kernel: Kernel log daemon terminating.<br/>Sep 18 03:20:28 bucketbox exiting on signal 15</pre>&#13;
<p>Certain logs will still continue to record Syslog on the host, so it may be desirable to edit /var/lib/syslog.conf and add comments to lines where a "-/var/log/some_filename" is specified as lines with "@x.x.x.x" dictate to forward to the Syslog aggregator.  As an example, I have marked the lines in bold to show where comments should be added to prevent further logging to the local disk:</p>&#13;
<pre># Save boot messages also to boot.log<br/>local7.*             @10.0.0.1<br/><strong># local7.*</strong><strong>         /var/log/boot.log</strong><br/><br/># Xapi rbac audit log echoes to syslog local6<br/>local6.*             @10.0.0.1<br/><strong># local6.*         -/var/log/audit.log</strong><br/><br/># Xapi, xenopsd echo to syslog local5<br/>local5.*             @10.0.0.1<br/><strong># local5.*</strong><strong>         -/var/log/xensource.log</strong><br/><br/></pre>&#13;
<p>After one - The Administrator - has decided what logs to keep and what logs to forward, Elastic Syslog can be restarted as so the changes take affect by executing:</p>&#13;
<p>/etc/init.d/syslog restart</p>&#13;
<p>Since Elastic Syslog - a part of XenServer - is being utilized, the init script will ensure that Elastic Syslog is bounced and that it is responsible for handling Syslog forwarding, etc.</p>&#13;
<p> </p>&#13;
<p>So, with this - I hope you find it useful and as always: feedback and comments are welcomed!</p>&#13;
<p> </p>&#13;
<p>--jkbs | @xenfomation</p>&#13;
<p> </p>&#13;
<p> </p>&#13;
<p> </p>&#13;
			&#13;
			&#13;
										&#13;
			&#13;
					</div>&#13;
&#13;
		&#13;
					&#13;
			
</div></body></html>
