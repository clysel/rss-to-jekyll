---
layout:     post
title: 	    "Sådan blev giftig krypterings-bug i FreeBSD opsnappet under tilfældig kodeinspektion"
post_author:	    Jakob Møllerhøj
post_date:	    Fri, 27 Feb 2015 05:29:00 +0000
post_site:	    www.version2.dk 
post_link:	    http://www.version2.dk/artikel/potentiel-giftig-krypterings-smutter-i-freebsd-opsnappet-efter-kodeinspektion-85884?utm_medium=feed&utm_source=version2.dk&utm_campaign=it_nyheder
---
<html><body><div><section class="body"><p>»Presserende. RNG (random number generator, red.) i stykker i de sidste fire måneder.«</p>

<p><a href="https://lists.freebsd.org/pipermail/freebsd-current/2015-February/054580.html">Sådan lød overskriften på den besked</a>, FreeBSD-udvikler John-Mark Gurney sendte ud via mailinglisten freebsd-current 17. februar.</p>

<p>Han havde opdaget et potentielt alvorligt it-sikkerhedshul i koden til generering af tilfældige tal i FreeBSD 11-CURRENT. Det er et udviklingstræ af open source-styresystemet, der leder frem mod den kommende FreeBSD 11. Styresystemet bliver brugt i flere sammenhænge, blandt andet som kodebase i embedde systemer - herunder <a href="http://en.wikipedia.org/wiki/Junos">routere</a>.</p>

<p>Fejlen er nu rettet, og dermed - med mindre den da bliver genintroduceret - ej heller i fare for at havne på listen over smuttere i udbredte open source-projekter, hvor kodeinspektion er gået helt galt og har resulteret i alvorlige it-sikkerhedshuller.</p>

<p>Den seneste tids måske nok mest kendte eksempler:</p>

<p><a href="http://en.wikipedia.org/wiki/Heartbleed">Heartbleed</a> - En bug i krypteringsbibioteket OpenSSL, der blev offentlig kendt april 2014. Den har gjort det muligt at hive private nøgler, brugeres sessioncookies og passwords ud af sårbare servere. Fejlen blev introduceret i OpenSSL december 2011.</p>



<p><a href="http://en.wikipedia.org/wiki/Shellshock_(software_bug)">ShellShock</a> - en bug i den udbredte kommandolinje-fortolker Bash til Unix-systemer blev offentliggjort september 2014. Fejlen gjorde det blandt andet muligt for en angriber at eksekvere kode på sårbare webservere. Fejlen i Bash har eksisteret siden 1989.</p>



<p>Så galt er det dog langt fra gået i forhold til fejlen i generatoren til tilfældige tal (RNG) i FreeBSD 11-CURRENT. Og heldigvis, for fejlen bevirker, at de tal, som RNG’en har spyttet ud, ikke har været så tilfældige, som de burde være.</p>

<p>Og det er skidt, da den mekanisme i sidste ende danner grundlag for de krypteringsnøgler, der er blevet genereret på FreeBSD-installationen.</p>

<p>»Dette betyder, at de fleste/alle nøgler genereret kan være forudsigelige og skal genereres på ny. Dette inkluderer, men er ikke begrænset til, ssh-nøgler og nøgler genereret via openssl. Dette er udelukkende et kernel-relateret problem, og en simpel kernel-opgradering med patchen er tilstrækkeligt til at fikse problemet,« skrev John-Mark Gurney ud til abonnenterne på freebsd-current.</p>

<h2>Svær at spotte</h2>

<p>V2-blogger og FreeBSD-udvikler Poul-Henning Kamp forklarer i en mail, at den konkrete fejl har bevirket, at de tilfældige bits, der indgår i forskellige kryptografiske sammenhænge, ikke er så tilfældige som de kunne og burde have været. Dermed ikke sagt, at, de krypteringsnøgler, der måtte være genereret på systemet, mens bug'en har været der, er værdiløse. Men, understreger Poul-Henning Kamp, de bør udskiftes omgående, for at være på den helt sikre side.</p>

<p>Han peger desuden på, at sådan en fejl er svær at spotte, da tilstrækkeligt tilfældige tal til forveksling ligner mindre tilfældige tal.</p>

<p>Hvis den type fejl skal opdages, kræver det en nærmere inspicering af koden, der står for genereringen af de pseudo-tilfældige tal. Og det var da også som følge af sådan en inspektion, at John-Mark Gurney opdagede, at noget var galt, forklarer han i en mail til Version2.</p>

<p>Han arbejde på at erstatte den eksisterende CSPRNG (cryptographically secure pseudo-random number generator) arc4random med en ny, ChaCha, da han besluttede sig for at se på, hvordan seedningen af RNG’en fandt sted.</p>

<p>Seedet er det input, der danner udgangspunktet for de tal, som en RNG genererer. Et simpelt seed kan eksempelvis være systemclocken.</p>



<p>John-Mark Gurney opdagede, at metoden read_random(), der bliver brugt i forbindelse med seeding, ikke blev initialiseret korrekt, og dermed var seed-data ikke gode nok.</p>

<p>Men hvad er egentlig sandsynligheden for, at en potentielt alvorlig fejl på den måde bliver opdaget i udviklingstræet af FreeBSD inden den endelige udgivelse?</p>

<p>»Det er et vanskeligt spørgsmål. Hvis ikke jeg havde vist en interesse i at se på den tilfældige nummergenerator, så ved jeg, at andre har en interesse og kunne have fundet bug'en. Jeg ved, at der er planlagt yderligere arbejde på systemet inden 11.0 (næste version af FreeBSD, red.) bliver frigivet, og det er sandsynligt, at bug'en kunne være blevet opdaget under dette arbejde,« skriver John-Mark Gurney.</p>

<h2>Inspireret på konference</h2>

<p>Inspirationen til at se på koden bag RNG-implementeringen fik han på BSD-konferencen EuroBSDcon 2014. Her havde flere fokus på netop RNG.</p>

<p>En præsentation fra NetBSD indeholdt en <a href="http://www.netbsd.org/gallery/presentations/riastradh/eurobsdcon2014/devrandom.pdf">slide med titlen 'Unpredictability mattes' (PDF)</a>med konkrete eksempler på, hvor galt det kan gå, når RNG ikke fungerer.</p>

<p>Et af eksemplerne er, hvordan den private <a href="http://en.wikipedia.org/wiki/Random_number_generator_attack#PlayStation_3">nøgle til signering af Sonys Playstation (3)-firmware blev blotlagt</a> som følge af dårlig RNG.</p>

<p>I FreeBSD-tilfældet er det dog nok begrænset, hvor mange RNG-bug’en kan have påvirket, vurderer Poul-Henning Kamp. Han peger på, at FreeBSD 11-CURRENT er ustabilt og ikke egner sig til et driftsmiljø, da der regelmæssigt ting, der pludselig ikke virker eller crashes, når ny kode ikke er kommet helt på plads.</p>

<p>»Omvendt kan alle dem der kører officielle releases af FreeBSD takke os for at de fleste fejl bliver luget ud inden de nogensinde kommer med i et officielt release,« skriver Poul-Henning Kamp.</p>

<p>Selvom bug’en kun måttet have berørt et fåtal af brugere, så foranlediger fejlen i i RNG’en også en evaluering, fortæller John-Mark Gurney.</p>

<p>»Når som helst en fejl som denne når forbi inspektion, bliver folk nødt til at evaluere, hvorfor den gjorde det, og hvordan man kan sikre, at lignende ting ikke sker igen,« skriver han.</p>

<p>I den forbindelse henviser John-Mark Gurney til et nyudrullet projekt på <a href="https://reviews.freebsd.org/">https://reviews.freebsd.org/</a> der har tilformål at gøre kodegennemgang lettere.</p>
  </section></div></body></html>
